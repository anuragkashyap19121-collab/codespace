<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Code Notepad (Lockable)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .CodeMirror { border: 1px solid #ced4da; height: 80vh; font-size: 15px; }
    #toast {
      position: fixed; bottom: 20px; right: 20px;
      background: #198754; color: white; padding: 10px 15px;
      border-radius: 5px; display: none;
    }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 id="workspace-name"></h3>
      <div>
        <button id="lockBtn" class="btn btn-outline-danger btn-sm">ðŸ”’ Lock</button>
        <button id="unlockBtn" class="btn btn-outline-success btn-sm" style="display:none;">ðŸ”“ Unlock</button>
      </div>
    </div>

    <div id="lockForm" class="mb-3" style="display:none;">
      <input type="password" id="lockPassword" class="form-control mb-2" placeholder="Enter password">
      <button id="submitLock" class="btn btn-danger btn-sm">Confirm Lock</button>
    </div>

    <textarea id="editor"></textarea>
    <div id="status" class="text-muted mt-2"></div>
  </div>

  <div id="toast">Code Saved âœ…</div>

  <script>
    $(document).ready(function () {
      const pathParts = window.location.pathname.split("/").filter(Boolean);
      const workspace = pathParts[0] || "default";
      $("#workspace-name").text("Workspace: " + workspace);
      const status = $("#status");
      let locked = false;

      const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true, mode: "python", theme: "default", lineWrapping: true
      });

      function showToast(msg = "Code Saved âœ…") {
        $("#toast").text(msg).stop(true, true).fadeIn(200).delay(1000).fadeOut(400);
      }

      // Load workspace data
      function loadCode() {
        $.getJSON(`/api/${workspace}`, function (data) {
          locked = data.locked || false;
          if (locked) {
            editor.setValue("// ðŸ”’ Workspace is locked.\nUse unlock button to enter password.");
            editor.setOption("readOnly", true);
            $("#lockBtn").hide();
            $("#unlockBtn").show();
          } else {
            editor.setValue(data.code || "");
            editor.setOption("readOnly", false);
            $("#lockBtn").show();
            $("#unlockBtn").hide();
          }
        });
      }

      // Unlock workspace
      $("#unlockBtn").click(() => {
        const pass = prompt("ðŸ” Enter password to unlock this workspace:");
        if (!pass) return;
        $.ajax({
          url: `/api/${workspace}/unlock`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ password: pass }),
          success: function (res) {
            if (res.status === "unlocked") {
              editor.setValue(res.code || "");
              editor.setOption("readOnly", false);
              locked = false;
              $("#lockBtn").show();
              $("#unlockBtn").hide();
              showToast("ðŸ”“ Workspace unlocked");
            } else {
              alert("âŒ Invalid password!");
            }
          },
          error: function (xhr) {
            const msg = xhr.responseJSON?.error || "âŒ Invalid password!";
            alert(msg);
          }
        });
      });

      // Auto save logic
      let saveTimer;
      editor.on("change", () => {
        if (locked) return;
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          const code = editor.getValue();
          $.ajax({
            url: `/api/${workspace}`,
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ code }),
            success: function () { showToast(); }
          });
        }, 1000);
      });

      // Lock button logic
      $("#lockBtn").click(() => {
        $("#lockForm").slideToggle();
      });

      $("#submitLock").click(() => {
        const password = $("#lockPassword").val().trim();
        if (!password) return alert("Enter a password!");
        $.ajax({
          url: `/api/${workspace}/lock`,
          method: "POST",
          contentType: "application/json",
          data: JSON.stringify({ password }),
          success: function () {
            showToast("ðŸ”’ Workspace Locked");
            $("#lockForm").slideUp();
            locked = true;
            editor.setOption("readOnly", true);
            $("#lockBtn").hide();
            $("#unlockBtn").show();
          }
        });
      });

      loadCode();
    });
  </script>
</body>
</html>
